//def shared_library_branch = scm.branches[0].name
//if (shared_library_branch .contains("*/")) {
//    shared_library_branch  = shared_library_branch.split("\\*/")[1]
//   }
//def util_lib="jenkins-shared@${shared_library_branch}"
//echo "${util_lib}"

//library "${util_lib}"

pipeline {
  agent { node { label 'alex' } }
    environment {
      docker_args="--device=/dev/kfd --device=/dev/dri --group-add video --group-add render --cap-add=SYS_PTRACE --security-opt seccomp=unconfined -v=/var/jenkins/:/var/jenkins"
  }
  parameters {
    string(name: 'PERF_TEST_OVERRIDE', defaultValue: '',  description: 'Add extra env vars for the MIOpenDriver cmd, comma separated')
    booleanParam(name: 'PERF_TEST_FP32', defaultValue : true, description: 'Run FP16 tests')
    booleanParam(name: 'PERF_TEST_FP16', defaultValue : true, description: 'Run FP16 tests')
    booleanParam(name: 'PERF_TEST_ARCHIVE', defaultValue : true, description: 'Archive results from this run')
  }
  stages {
        stage("Performance Tests - gfx942") {
            //when {
            //    expression {params.PERF_TEST && params.TARGET_GFX90A}
            //}
            parallel{
                stage('Fp32 BS128 Hip Performance Resnet50_v1.5 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        echo "TEST"
                        script {
                        def utils = load "vars/utils.groovy"
                        library ${utils}
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1.5_FP32_BS128.txt" )
                        }
                    }
                }/*
                stage('Fp32 BS256 Hip Performance Resnet50_v1.5 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1.5_FP32_BS256.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance Resnet50_v1.5 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1.5_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Resnet50_v1.5 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1.5_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS256 Hip Performance Resnet50_v1.5 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1.5_FP16_BS256.txt" )
                        }
                    }
                }
                stage('Fp16 BS512 Hip Performance Resnet50_v1.5 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1.5_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Alexnet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Alexnet_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS512 Hip Performance Alexnet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Alexnet_v1_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS4 Hip Performance Alexnet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Alexnet_v1_FP32_BS4.txt" )
                        }
                    }
                }
                stage('Fp32 BS64 Hip Performance Alexnet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Alexnet_v1_FP32_BS64.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance Alexnet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Alexnet_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance Alexnet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Alexnet_v1_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS256 Hip Performance Densenet201_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Densenet201_v1_FP16_BS256.txt" )
                        }
                    }
                }
                stage('Fp32 BS256 Hip Performance Densenet201_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Densenet201_v1_FP32_BS256.txt" )
                        }
                    }
                }
                stage('Fp16 BS256 Hip Performance Densenet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Densenet_v1_FP16_BS256.txt" )
                        }
                    }
                }
                stage('Fp32 BS256 Hip Performance Densenet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Densenet_v1_FP32_BS256.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Googlenet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Googlenet_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS512 Hip Performance Googlenet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Googlenet_v1_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance Googlenet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Googlenet_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance Googlenet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Googlenet_v1_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Inception3_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Inception3_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance Inception3_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Inception3_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance Inception3_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Inception3_v1_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Inception4_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Inception4_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS512 Hip Performance Inception4_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Inception4_v1_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance Inception4_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Inception4_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance Inception4_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Inception4_v1_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS4 Hip Performance Mobilenet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Mobilenet_v1_FP32_BS4.txt" )
                        }
                    }
                }
                stage('Fp32 BS64 Hip Performance Mobilenet_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Mobilenet_v1_FP32_BS64.txt" )
                        }
                    }
                }
                stage('Fp16 BS32 Hip Performance Resnet101_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet101_v1_FP16_BS32.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Resnet101_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet101_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS256 Hip Performance Resnet101_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet101_v1_FP16_BS256.txt" )
                        }
                    }
                }
                stage('Fp16 BS512 Hip Performance Resnet101_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet101_v1_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance Resnet101_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet101_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS256 Hip Performance Resnet101_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet101_v1_FP32_BS256.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance Resnet101_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet101_v1_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS256 Hip Performance Resnet152_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet152_v1_FP16_BS256.txt" )
                        }
                    }
                }
                stage('Fp32 BS256 Hip Performance Resnet152_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet152_v1_FP32_BS256.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Resnet152_v2 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet152_v2_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS512 Hip Performance Resnet152_v2 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet152_v2_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance Resnet152_v2 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet152_v2_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance Resnet152_v2 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet152_v2_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS32 Hip Performance Resnet50_v1 gfx1201'){

                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1_FP16_BS32.txt" )
                        }
                    }
                }
                stage('Fp16 BS64 Hip Performance Resnet50_v1 gfx1201'){

                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1_FP16_BS64.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Resnet50_v1 gfx1201'){

                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS256 Hip Performance Resnet50_v1 gfx1201'){

                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1_FP16_BS256.txt" )
                        }
                    }
                }
                stage('Fp16 B512 Hip Performance Resnet50_v1 gfx1201'){

                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance Resnet50_v1 gfx1201'){

                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS256 Hip Performance Resnet50_v1 gfx1201'){

                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1_FP32_BS256.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance Resnet50_v1 gfx1201'){

                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Resnet50_v1_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance Shufflenet_v2 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "Shufflenet_v2_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance SSD_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "SSD_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance SSD_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "SSD_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance VGG11_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG11_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS256 Hip Performance VGG11_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG11_v1_FP16_BS256.txt" )
                        }
                    }
                }
                stage('Fp16 BS512 Hip Performance VGG11_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG11_v1_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance VGG11_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG11_v1_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance VGG16_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG16_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS4 Hip Performance VGG16_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG16_v1_FP32_BS4.txt" )
                        }
                    }
                }
                stage('Fp32 BS64 Hip Performance VGG16_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG16_v1_FP32_BS64.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance VGG16_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG16_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance VGG16_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG16_v1_FP32_BS512.txt" )
                        }
                    }
                }
                stage('Fp16 BS128 Hip Performance VGG19_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG19_v1_FP16_BS128.txt" )
                        }
                    }
                }
                stage('Fp16 BS512 Hip Performance VGG19_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP16}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG19_v1_FP16_BS512.txt" )
                        }
                    }
                }
                stage('Fp32 BS128 Hip Performance VGG19_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG19_v1_FP32_BS128.txt" )
                        }
                    }
                }
                stage('Fp32 BS512 Hip Performance VGG19_v1 gfx1201'){
                    when {
                        expression {params.PERF_TEST_FP32}
                    }
                    steps{
                        script {
                        utils.RunPerfTest(gpu_arch: "gfx1201", filename: "VGG19_v1_FP32_BS512.txt" )
                        }
                    }
                }*/
            }
        }
  }
}
